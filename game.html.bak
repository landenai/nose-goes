<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/fabric"></script>
  <script src="config.js"></script>
</head>

<body>
  <canvas id="canvas" width="1280" height="700"></canvas>
</body>

<script>
  const PLAYER_WIDTH = 35;
  const PLAYER_HEIGHT = 40;

  const playerInstances = {};

  const canvas = new fabric.Canvas('canvas');
  const socket = new WebSocket(CONFIG.websocketEndpoint);

  // connect as view
  socket.addEventListener("open", (event) => {
    socket.send(JSON.stringify({ type: "initView" }));
  });

  // handle game state update
  socket.addEventListener("message", (event) => {
    console.log("Message from server ", event.data);
    try {
      const state = JSON.parse(event.data);

      Object.keys(state.players).forEach(id => {
        const { position } = state.players[id];

        if (!playerInstances[id]) {
          const rect = new fabric.Rect({
            top: position.y,
            left: position.x,
            width: 35,
            height: 40,
            fill: 'red',
          });

          playerInstances[id] = rect;

          canvas.add(rect);
        } else {
          // just move the player instance
          console.log(`updated position: (${position.x}, ${position.y})`)
          playerInstances[id].set({ top: position.y, left: position.x });
        }

        canvas.renderAll();
      });
    } catch (e) {
      console.error('malformed game state!', e);
    }
  });

</script>

</html>
