<html>

<head>
  <script src="joy.js"></script>
  <script src="config.js"></script>
</head>

<body>
  <div id="joyDiv"
    style="width:50vh;height:50vh;margin-bottom:20px; position: absolute; bottom:10vh; margin-left: auto; margin-right: auto; left: 0; right: 0">
  </div>
</body>

<script>
  const ARROW_LEFT = 37;
  const ARROW_UP = 38;
  const ARROW_RIGHT = 39;
  const ARROW_DOWN = 40;

  // Player state
  const direction = {
    x: 0,
    y: 0,
  };

  const Joy1 = new JoyStick('joyDiv', {}, (stickData) => {
    direction.x = Number(stickData.x);
    direction.y = Number(-stickData.y);
  });

  const socket = new WebSocket(CONFIG.websocketEndpoint);

  // connect as player
  socket.addEventListener("open", (event) => {
    socket.send(JSON.stringify({ type: "initPlayer", data: { name: "Binh" } }));
  });

  // handle server message
  // no current use
  socket.addEventListener("message", (event) => {
    console.log("Message from server ", event.data);
  });

  // handle connection close
  socket.addEventListener("close", (event) => {
    console.log("Connection closed: ", event.data);
  });

  // handle key inputs
  window.addEventListener("keydown", ({ keyCode, repeat }) => {
    if (repeat) return;
    switch (keyCode) {
      case ARROW_UP:
        direction.y -= 1;
        break;
      case ARROW_DOWN:
        direction.y += 1;
        break;
      case ARROW_LEFT:
        direction.x -= 1;
        break;
      case ARROW_RIGHT:
        direction.x += 1;
        break;
    }
  });

  window.addEventListener("keyup", ({ keyCode }) => {
    switch (keyCode) {
      case ARROW_UP:
        direction.y += 1;
        break;
      case ARROW_DOWN:
        direction.y -= 1;
        break;
      case ARROW_LEFT:
        direction.x += 1;
        break;
      case ARROW_RIGHT:
        direction.x -= 1;
        break;
    }
  });

  // assumes that x and y are non-zero (because of where it is invoked in `onTick()`
  const normalizeDirection = ({ x, y }) => {
    let magnitude = 1 / Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));
    return {
      x: x * magnitude,
      y: y * magnitude,
    };
  };

  // every x ms, send direction vector update
  // `isMoving` acts as a toggle, indicating that the joystick
  // has returned to a resting state
  let isMoving = false;
  const onTick = () => {
    if (direction.x || direction.y) {
      isMoving = true;

      let normalized = normalizeDirection(direction);
     //  console.log(` direction: ${JSON.stringify(direction)}`);
     //  console.log(`normalized: ${JSON.stringify(normalized)}`);

      socket.send(JSON.stringify({ type: "move", data: { direction: normalized } }));
    } else if (isMoving) {
      isMoving = false;
      socket.send(JSON.stringify({ type: "move", data: { direction } }));
    }
    setTimeout(onTick, CONFIG.refreshRateMS);
  };

  onTick();
</script>

</html>
