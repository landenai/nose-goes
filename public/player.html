<html>

<head>
  <script src="joy.js"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="title">👃🏽Nose Goes👃🏽</div>
  <div class="player">
    <img class="idle" id="player-image" src="assets/idle/idle1.png"/>
  </div>
  <div class="user-input">
    <div class="name" id="name-container">
      <input  class="name" id="name-input" type="text" oninput="onNameChange(this.value)" maxlength="20" placeholder="Who dis?"></input>
      <button onclick="onSubmit()">🐽</button>
    </div>
    <div hidden id="joyDiv"
      style="width:50vh;height:50vh;margin-bottom:20px; bottom:10vh; margin-left: auto; margin-right: auto; left: 0; right: 0">
    </div>
  </div>


</body>


<script>
  const socket = new WebSocket(CONFIG.websocketEndpoint);
  // handle server message
  // no current use
  socket.addEventListener("message", (event) => {
    console.log("Message from server ", event.data);
  });

  // handle connection close
  socket.addEventListener("close", (event) => {
    console.log("Connection closed: ", event.data);
  });

  const onNameChange = (name) => {
    const img = document.getElementById('player-image');
    img.src = name ? `https://api.dicebear.com/8.x/bottts/svg?seed=${name}` : 'assets/idle/idle1.png';
  }
  const onSubmit = () => {
    const name = document.getElementById('name-input').value
    if(!name) return; 
    document.getElementById('name-container').hidden = true;
    socket.send(JSON.stringify({ type: "initPlayer", data: { name } }));
    document.getElementById('joyDiv').hidden = false;
    new JoyStick('joyDiv', {}, (stickData) => {
      direction.x = Number(stickData.x);
      direction.y = Number(-stickData.y);
    });
  }
  // Player state
  const direction = {
    x: 0,
    y: 0,
  };


  // assumes that x and y are non-zero (because of where it is invoked in `onTick()`
  const normalizeDirection = ({ x, y }) => {
    let magnitude = 1 / Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));
    return {
      x: x * magnitude,
      y: y * magnitude,
    };
  };

  // every x ms, send direction vector update
  const onTick = () => {
    if (direction.x || direction.y) {
      let normalized = normalizeDirection(direction);

      socket.send(JSON.stringify({ type: "move", data: { direction: normalized } }));
    }
    setTimeout(onTick, CONFIG.refreshRateMS);
  };

  onTick();
</script>

</html>
