<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@v3.80.1/dist/phaser.min.js"></script>
    <script src="config.js"></script>
  </head>
<body>

  
  <script>

    // ------- phaser painting -------- // 
    class Example extends Phaser.Scene
    {
        constructor ()
        {  
          super();
          this.playerInstances = {};
        }

        preload ()
        {
            this.load.path = 'assets/run/';

            this.load.image('run1', 'run1.png');
            this.load.image('run2', 'run2.png');
            this.load.image('run3', 'run3.png');
            this.load.image('run4', 'run4.png');
            this.socket = new WebSocket(CONFIG.websocketEndpoint);

            this.socket.addEventListener("open", (event) => {
               this.socket.send(JSON.stringify({ type: "initView" }));
             });

            this.socket.addEventListener("message", (event) => {
              console.log("Message from server ", event.data);
              try {
                const state = JSON.parse(event.data);

                Object.keys(state.players).forEach(id => {
                  const { position } = state.players[id];

                  if (!this.playerInstances[id]) {
                    let player = this.playerInit();
                    this.playerInstances[id] = player;
                  } else {
                    // just move the player instance
                    console.log(`updated position: (${position.x}, ${position.y})`)
                    this.playerInstances[id].setX(position.x);
                    this.playerInstances[id].setY(position.y);
                  }
                });
              } catch (e) {
                console.error('malformed game state!', e);
              }
            });
        }

        create ()
        {}
        playerInit() {
          this.anims.create({
                key: 'run',
                frames: [
                    { key: 'run1' },
                    { key: 'run2' },
                    { key: 'run3' },
                    { key: 'run4', duration: 100 }
                    
                ],
                frameRate: 8,
                repeat: -1
            });
            let player = this.add.sprite(400, 300, 'run1')
                .play('run');

            return player;
        }
      
    }

    const config = {
        type: Phaser.AUTO,
        parent: 'phaser-example',
        width: 1280,
        height: 700,
        backgroundColor: '#fbf0e4',
        scene: Example
    };

    const game = new Phaser.Game(config);

  </script>


</body>
</html>
