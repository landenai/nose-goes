<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@v3.80.1/dist/phaser.min.js"></script>
    <script src="config.js"></script>
  </head>
<body>
  <script>

    // ------- phaser painting -------- // 
    class Example extends Phaser.Scene
    {
        constructor () {
          super();
          this.playerInstances = {};
          this.winners = {};
          this.nose = {};
        }

        preload () {
            this.load.path = 'assets/run/';

            this.load.image('run1', 'run1.png');
            this.load.image('run2', 'run2.png');
            this.load.image('run3', 'run3.png');
            this.load.image('run4', 'run4.png');

            this.load.path = 'assets/idle/';

            this.load.image('idle1', 'idle1.png');
            this.load.image('idle2', 'idle2.png');
            this.load.image('idle3', 'idle3.png');
            this.load.image('idle4', 'idle4.png');
            this.load.image('idle5', 'idle5.png');

            this.load.path = 'assets/nose/';

            this.load.svg('nose', 'nose.svg',{width: 100, height: 100})

            this.socket = new WebSocket(CONFIG.websocketEndpoint);

            this.socket.addEventListener("open", (event) => {
               this.socket.send(JSON.stringify({ type: "initView" }));
             });

            this.socket.addEventListener("message", (event) => {
              try {
                const state = JSON.parse(event.data);
                Object.keys(state.players).forEach(id => {
                  const { position, isMoving } = state.players[id];

                  if (!this.playerInstances[id]) {
                    this.playerInstances[id] = this.playerInit();
                  } else {
                    // just move the player instance
                    if (isMoving) {
                      this.physics.moveTo(
                        this.playerInstances[id],
                        position.x,
                        position.y,
                        140, // speed (px/s), should be higher than ~2 * player.html refreshRate * gameState SPEED

                      );
                    } else { 
                      this.playerInstances[id].body.reset(position.x, position.y);
                    }
                  }
                });

                if(state.nose) {
                  this.drawNose(state.nose.currentLocation);
                }
              } catch (e) {
                console.error('malformed game state!', e);
              }
            });
        }

        create() {
          this.anims.create({
              key: 'idle',
                frames: [
                    { key: 'idle1' },
                    { key: 'idle2' },
                    { key: 'idle3' },
                    { key: 'idle4' },
                    { key: 'idle5', duration: 100 }
                   
                ],
                frameRate: 8,
                repeat: -1
            });

            this.anims.create({
                key: 'run',
                frames: [
                    { key: 'run1' },
                    { key: 'run2' },
                    { key: 'run3' },
                    { key: 'run4', duration: 100 }
                    
                ],
                frameRate: 8,
                repeat: -1
            });
            this.physics.world.on('overlap', (gameObject1, gameObject2, body1, body2) => {
              console.log("overlap")
            });
        }

        playerInit() {
            const playerSprite = this.add.sprite(0, 0, 'run1').play('run');
            playerSprite.setScale(1.2);

            const playerContainer = this.add.container(400, 300, [playerSprite]);
            this.physics.world.enableBody(playerContainer);

            playerContainer.body.onOverlap = true;
            this.physics.add.overlap(playerContainer, this.nose)

            // add face towards top
            let rnd = 'Binh' + Math.random();
            this.load.image({
              key: rnd,
              url: 'https://api.dicebear.com/8.x/bottts/svg?seed=Mittens',
            });
            let scene = this;

            this.load.on(`filecomplete-image-${rnd}`, function (key, type, data) {
              const face = scene.add.image(0, -20, rnd);
              face.setScale(0.3);
              playerContainer.add(face);
            });
            this.load.start();

            return playerContainer;
        }

        drawNose({x,y}) {
          this.nose = this.physics.add.image(x, y, 'nose');
        }

        checkForFinish() {

        }
      
    }

    const config = {
        type: Phaser.AUTO,
        parent: 'phaser-example',
        width: 1280,
        height: 700,
        backgroundColor: '#fbf0e4',
        physics: {
          default: 'arcade',
        },
        scene: Example
    };

    const game = new Phaser.Game(config);

  </script>


</body>
</html>
