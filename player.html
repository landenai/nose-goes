<!-- render a mobile friendly canvas -->
<script src="joy.js"></script>
<body>
  <div id="joyDiv" style="width:50vh;height:50vh;margin-bottom:20px; position: absolute; bottom:10vh; margin-left: auto; margin-right: auto; left: 0; right: 0"></div>
</body>
<script>
  const ARROW_LEFT = 37;
  const ARROW_UP = 38;
  const ARROW_RIGHT = 39;
  const ARROW_DOWN = 40;

  // Player state
  const direction = {
    x: 0,
    y: 0,
  };
  const Joy1 = new JoyStick('joyDiv', {}, function(stickData) {
    direction.x = stickData.x/100.0
    direction.y = -(stickData.y/100.0)
});
  const socket = new WebSocket("wss://f4fb-2602-fb65-0-100-fdb4-4aa9-11d1-b26.ngrok-free.app");



  // connect as player
  socket.addEventListener("open", (event) => {
    socket.send(JSON.stringify({ type: "initPlayer", data: { name: "Binh" }}));
  });

  // handle server message
  // no current use
  socket.addEventListener("message", (event) => {
    console.log("Message from server ", event.data);
  });

  // handle key inputs
  window.addEventListener("keydown", ({ keyCode, repeat }) => {
    if (repeat) return;

    console.log(`keydown: ${keyCode}`);

    switch (keyCode) {
      case ARROW_UP:
        direction.y -= 1;
        break;
      case ARROW_DOWN:
        direction.y += 1;
        break;
      case ARROW_LEFT:
        direction.x -= 1;
        break;
      case ARROW_RIGHT:
        direction.x += 1;
        break;
    }
  });

  window.addEventListener("keyup", ({ keyCode }) => {
    console.log(`keyup: ${keyCode}`);

    switch (keyCode) {
      case ARROW_UP:
        direction.y += 1;
        break;
      case ARROW_DOWN:
        direction.y -= 1;
        break;
      case ARROW_LEFT:
        direction.x += 1;
        break;
      case ARROW_RIGHT:
        direction.x -= 1;
        break;
    }
  });

  const onTick = () => {
    if (direction.x || direction.y) {
      console.log(`direction: ${JSON.stringify(direction)}`);
      socket.send(JSON.stringify({ type: "move", data: { direction }}));
    }
    setTimeout(onTick, 20);
  };

  onTick();
</script>
